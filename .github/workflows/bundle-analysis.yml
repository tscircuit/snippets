 name: Size Analysis                                                                                                       
                                                                                                                           
 on:                                                                                                                       
   pull_request_target:                                                                                                    
     branches:                                                                                                             
       - main                                                                                                              
     types: [opened, synchronize]                                                                                          
   pull_request:                                                                                                           
     branches:                                                                                                             
       - main                                                                                                              
                                                                                                                           
 permissions:                                                                                                              
   pull-requests: write                                                                                                    
   contents: read                                                                                                          
                                                                                                                           
 jobs:                                                                                                                     
   size:                                                                                                                   
     name: Report bundle size                                                                                              
     runs-on: ubuntu-latest                                                                                                
     timeout-minutes: 30                                                                                                   
     steps:                                                                                                                
       - name: Checkout PR                                                                                                 
         uses: actions/checkout@v3                                                                                         
         with:                                                                                                             
           ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}      
           persist-credentials: false                                                                                      
                                                                                                                           
       - name: Setup Bun                                                                                                   
         uses: oven-sh/setup-bun@v1                                                                                        
         with:                                                                                                             
           bun-version: latest                                                                                             
                                                                                                                           
       - name: Install dependencies                                                                                        
         run: bun install                                                                                                  
                                                                                                                           
       - name: Build with bundle analysis                                                                                  
         run: VITE_BUNDLE_ANALYZE=true bun run build                                                                       
                                                                                                                           
       - name: Analyze bundle                                                                                              
         id: bundle-analysis                                                                                               
         run: |                                                                                                            
           echo "stats=$(jq -r '                                                                                           
             .children[] |                                                                                                 
             select(.size > 1000) |                                                                                        
             "\(.name): \(.size/1024|floor)KB"                                                                             
           ' stats.html | sort -rn -t: -k2)" >> $GITHUB_OUTPUT                                                             
                                                                                                                           
       - name: Add PR Comment                                                                                              
         uses: mshick/add-pr-comment@v2                                                                                    
         with:                                                                                                             
           message: |                                                                                                      
             Bundle Size Report                                                                                            
                                                                                                                           
             Showing modules larger than 1KB:                                                                              
                                                                                                                           
             ${{ steps.bundle-analysis.outputs.stats }}                                                                    
           proxy-url: https://add-pr-comment-proxy-tscircuit.vercel.app/api                                                
           repo-token: ${{ secrets.GITHUB_TOKEN }}                                                                         
           allow-repeats: false                                                                                            
                                       
