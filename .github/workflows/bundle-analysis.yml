 name: Bundle Size Analysis                                                                                                
                                                                                                                           
 on:                                                                                                                       
   pull_request_target:                                                                                                    
     branches:                                                                                                             
       - main                                                                                                              
     types: [opened, synchronize]                                                                                          
   pull_request:                                                                                                           
     branches:                                                                                                             
       - main                                                                                                              
                                                                                                                           
 permissions:                                                                                                              
   pull-requests: write                                                                                                    
   contents: read                                                                                                          
                                                                                                                           
 jobs:                                                                                                                     
   analyze:                                                                                                                
     name: Analyze Bundle Size                                                                                             
     runs-on: ubuntu-latest                                                                                                
     timeout-minutes: 30                                                                                                   
     steps:                                                                                                                
       # First checkout and build main                                                                                     
       - name: Checkout main                                                                                               
         uses: actions/checkout@v3                                                                                         
         with:                                                                                                             
           ref: main                                                                                                       
           persist-credentials: false                                                                                      
                                                                                                                           
       - name: Setup Bun                                                                                                   
         uses: oven-sh/setup-bun@v1                                                                                        
         with:                                                                                                             
           bun-version: latest                                                                                             
                                                                                                                           
       - name: Install dependencies (main)                                                                                 
         run: bun install                                                                                                  
                                                                                                                           
       - name: Build main branch                                                                                           
         run: |                                                                                                            
           ANALYZE=true bun run build                                                                                      
           ls -la dist/stats.html || echo "Stats file not found"                                                           
                                                                                                                           
       - name: Save main stats                                                                                             
         run: |                                                                                                            
           mkdir -p /tmp/stats                                                                                             
           cp dist/stats.html /tmp/stats/main-stats.html                                                                   
                                                                                                                           
       # Now checkout and build PR                                                                                         
       - name: Checkout PR                                                                                                 
         uses: actions/checkout@v3                                                                                         
         with:                                                                                                             
           ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}      
           persist-credentials: false                                                                                      
                                                                                                                           
       - name: Install dependencies (PR)                                                                                   
         run: bun install                                                                                                  
                                                                                                                           
       - name: Build PR branch                                                                                             
         run: ANALYZE=true bun run build                                                                                   
                                                                                                                           
       - name: Generate Size Report                                                                                        
         id: size-report                                                                                                   
         run: |                                                                                                            
           # Get total sizes and calculate difference                                                                      
           main_total=$(jq -r '.size' /tmp/stats/main-stats.html)                                                          
           pr_total=$(jq -r '.size' dist/stats.html)                                                                       
           main_total_kb=$((main_total / 1024))                                                                            
           pr_total_kb=$((pr_total / 1024))                                                                                
           diff_kb=$((pr_total_kb - main_total_kb))                                                                        
           diff_percent=$(( (diff_kb * 100) / main_total_kb ))                                                             
                                                                                                                           
           # Format the difference with sign                                                                               
           if [ $diff_kb -ge 0 ]; then                                                                                     
             diff_formatted="+${diff_kb}"                                                                                  
             diff_percent_formatted="+${diff_percent}"                                                                     
           else                                                                                                            
             diff_formatted="${diff_kb}"                                                                                   
             diff_percent_formatted="${diff_percent}"                                                                      
           fi                                                                                                              
                                                                                                                           
           echo "main_total=$main_total_kb" >> $GITHUB_OUTPUT                                                              
           echo "pr_total=$pr_total_kb" >> $GITHUB_OUTPUT                                                                  
           echo "diff=$diff_formatted" >> $GITHUB_OUTPUT                                                                   
           echo "diff_percent=$diff_percent_formatted" >> $GITHUB_OUTPUT                                                   
                                                                                                                           
           # Get breakdown of major chunks and dependencies                                                                
           echo "breakdown=$(jq -r '                                                                                       
             .children[] |                                                                                                 
             select(.size > 5000) |                                                                                        
             {                                                                                                             
               name: .name,                                                                                                
               size: (.size/1024|floor),                                                                                   
               percent: ((.size/.parent.size)*100|floor)                                                                   
             } |                                                                                                           
             "\(.name): \(.size)KB (\(.percent)%)"                                                                         
           ' dist/stats.html | sort -rn -t: -k2 | head -n 10)" >> $GITHUB_OUTPUT                                           
                                                                                                                           
           # Get asset types breakdown                                                                                     
           echo "assets=$(jq -r '                                                                                          
             .children[] |                                                                                                 
             select(.name | endswith(".js") or endswith(".css") or endswith(".html")) |                                    
             {                                                                                                             
               type: (.name | split(".") | last),                                                                          
               size: .size                                                                                                 
             }                                                                                                             
           ' dist/stats.html | jq -s 'group_by(.type) | map({                                                              
             type: .[0].type,                                                                                              
             total_size: (map(.size) | add | . / 1024 | floor)                                                             
           }) | map("\(.type): \(.total_size)KB")[]' | sort -r)" >> $GITHUB_OUTPUT                                         
                                                                                                                           
       - name: Add PR Comment                                                                                              
         uses: mshick/add-pr-comment@v2                                                                                    
         with:                                                                                                             
           message: |                                                                                                      
             # 📦 Bundle Size Report                                                                                       
                                                                                                                           
             ## Total Bundle Size                                                                                          
             Current: **${{ steps.size-report.outputs.pr_total }}KB**                                                      
             Diff from main: **${{ steps.size-report.outputs.diff }}KB (${{ steps.size-report.outputs.diff_percent }}%)**  
                                                                                                                           
             > Base size (main): ${{ steps.size-report.outputs.main_total }}KB                                             
                                                                                                                           
             ## Top Chunks by Size                                                                                         
             Showing modules larger than 5KB:                                                                              
             ```                                                                                                           
             ${{ steps.size-report.outputs.breakdown }}                                                                    
             ```                                                                                                           
                                                                                                                           
             ## Assets by Type                                                                                             
             ```                                                                                                           
             ${{ steps.size-report.outputs.assets }}                                                                       
             ```                                                                                                           
                                                                                                                           
             <details>                                                                                                     
             <summary>ℹ️ About this report</summary>                                                                       
                                                                                                                           
             - Sizes are shown in kilobytes (KB)                                                                           
             - Percentages show relative size compared to total bundle                                                     
             - Only modules larger than 5KB are listed                                                                     
             - Asset types include .js, .css, and .html files                                                              
             - Diff shows size change compared to main branch                                                              
             </details>                                                                                                    
           proxy-url: https://add-pr-comment-proxy-tscircuit.vercel.app/api                                                
           repo-token: ${{ secrets.GITHUB_TOKEN }}                                                                         
           allow-repeats: false                                                                                            
